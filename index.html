<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Vietnam Map (Leaflet.js)</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load Leaflet CSS and JS from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; 
        }
        
        /* Container for Leaflet Map */
        #leaflet-map {
            width: 100%;
            height: 60vh; /* Adjusted height for better layout with recommendations */
            margin: 0 auto;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        /* Ensure Leaflet Popup/Tooltip looks good */
        .leaflet-popup-content-wrapper {
            border-radius: 8px !important;
        }

        .leaflet-popup-content {
            font-weight: 500;
        }

        /* Recommendation card styles */
        .recommendation-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .recommendation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.2);
            border-color: #4f46e5;
        }
        
        .card-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 0.75rem 0.75rem 0 0;
            /* Ensure placeholder text is readable and centered */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
            text-align: center;
            line-height: 1.2;
            padding: 8px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="mx-auto max-w-7xl text-center"> 
        <header class="mb-6">
            <h1 class="text-3xl font-extrabold text-indigo-700 mb-1">
                Interactive Detailed Map of Vietnam
            </h1>
            <p class="text-gray-600">Using Leaflet.js and OpenStreetMap to display tourist attractions.</p>
        </header>

        <!-- Search and Filter Bar -->
        <div class="mb-6 max-w-4xl mx-auto flex space-x-3">
            <input type="text" id="name-search-input" placeholder="Search by name or address..." 
                   class="flex-grow p-3 border-2 border-indigo-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150 shadow-md">
            
            <select id="city-filter" 
                    class="w-40 p-3 border-2 border-indigo-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150 shadow-md bg-white">
                <option value="">Filter by City</option>
                <!-- City options will be populated by JS -->
            </select>
        </div>

        <!-- Leaflet Map Container -->
        <div id="leaflet-map" class="max-w-4xl mx-auto mb-6">
            <!-- Map will be initialized here -->
        </div>
        
        <!-- Top Recommended Places / Search Results -->
        <div id="recommendations-container" class="mt-6 max-w-7xl mx-auto text-left">
            <h3 class="text-xl font-semibold text-gray-800 mb-3">
                Top Recommended Places
                <span id="search-results-count" class="text-sm font-normal text-gray-500 ml-2"></span>
            </h3>
            <div id="recommendations-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Recommendations will be generated by JS -->
            </div>
        </div>
        
    </div>

    <script>
        // Enhanced Location Data (Translated and Mocked Description/Image)
        const rawLocations = [
            // Format: [lat, lng, name, address, city, description, image_url_stub (400x120/BgColor/TextColor?text=Description)]
            [21.0285, 105.8542, "Old Quarter", "Hoan Kiem District, Hanoi", "Hanoi", "The historic heart of Hanoi, famous for its narrow streets and traditional architecture and bustling night life.", "400x120/4f46e5/ffffff?text=Hanoi+Old+Town"],
            [21.0300, 105.8550, "Ta Hien Street", "Hoan Kiem District, Hanoi", "Hanoi", "Known as 'Beer Street', a lively hub for local and foreign tourists to enjoy street food and beverages.", "400x120/3b82f6/ffffff?text=Beer+Street"],
            [21.0203, 105.8518, "St. Joseph's Cathedral", "40 Nha Chung St., Hoan Kiem District, Hanoi", "Hanoi", "A stunning Gothic-style Roman Catholic cathedral built in 1886, a major religious landmark.", "400x120/10b981/ffffff?text=Gothic+Cathedral"],
            [21.0330, 105.8450, "Train Street", "Tran Phu Street, Ba Dinh District, Hanoi", "Hanoi", "A unique narrow residential street where an active train passes just inches away from houses.", "400x120/f97316/ffffff?text=Train+Passes+By"],
            [21.0368, 105.8342, "Ho Chi Minh Mausoleum", "2 Hung Vuong, Ba Dinh District, Hanoi", "Hanoi", "The final resting place of the revolutionary leader Ho Chi Minh, a place of historical significance.", "400x120/a855f7/ffffff?text=Historic+Mausoleum"],
            [21.0285, 105.8522, "Hoan Kiem Lake", "Hoan Kiem District, Hanoi", "Hanoi", "A central lake in Hanoi, home to Ngoc Son Temple and the iconic Turtle Tower.", "400x120/14b8a6/ffffff?text=Scenic+Lake"],
            
            [10.7797, 106.7009, "Notre Dame Cathedral", "1 Cong Xa Paris, Dist. 1, HCMC", "HCMC", "A beautiful colonial-era cathedral built with materials imported from France, a key city symbol.", "400x120/ef4444/ffffff?text=Colonial+Church"], 
            [10.7799, 106.7018, "Central Post Office", "2 Cong Xa Paris, Dist. 1, HCMC", "HCMC", "A stunning example of French colonial architecture, still a functioning post office today.", "400x120/22c55e/ffffff?text=French+Architecture"],
            [10.7725, 106.6983, "Ben Thanh Market", "45 Le Loi, Dist. 1, HCMC", "HCMC", "One of the most famous landmarks in Ho Chi Minh City, offering everything from food to souvenirs.", "400x120/eab308/ffffff?text=Bustling+Market"],
            [10.7719, 106.7042, "Bitexco Financial Tower", "2 Hai Trieu, Dist. 1, HCMC", "HCMC", "A modern skyscraper with an observation deck, offering panoramic views of the city.", "400x120/ec4899/ffffff?text=City+Skyline+View"],

            [15.8794, 108.3364, "Hoi An Ancient Town", "Minh An Ward, Hoi An City, Quang Nam", "Quang Nam", "A UNESCO World Heritage site known for its well-preserved traditional architecture and canals.", "400x120/06b6d4/ffffff?text=Lanterns+%26+Canals"], 
            [15.8767, 108.3262, "Japanese Bridge", "Hoi An Ancient Town, Quang Nam", "Quang Nam", "An iconic covered bridge built in the 17th century, linking two halves of the town.", "400x120/f97316/ffffff?text=Iconic+Bridge"],

            [16.0678, 108.2199, "Dragon Bridge", "Hai Chau District, Da Nang", "Da Nang", "A modern bridge famous for its design and weekend fire/water show.", "Da Nang", "400x120/6366f1/ffffff?text=Dragon+Bridge+Show"], 
            [16.0465, 108.2435, "My Khe Beach", "Son Tra District, Da Nang", "Da Nang", "A long stretch of white sand known for its clear water and excellent surfing conditions.", "Da Nang", "400x120/34d399/ffffff?text=White+Sand+Beach"],

            [20.8930, 107.0300, "Ha Long Bay", "Ha Long City, Quang Ninh", "Quang Ninh", "A breathtaking UNESCO World Heritage Site famous for its thousands of limestone karsts and islands.", "400x120/0ea5e9/ffffff?text=Limestone+Karsts"],
            [22.3486, 103.8400, "Ham Rong Mountain", "Sapa Town, Lao Cai", "Lao Cai", "Offering stunning panoramic views of Sapa town and the surrounding mountains and valleys.", "400x120/7c3aed/ffffff?text=Mountain+View"], 
            [20.2450, 105.9750, "Trang An Scenic Landscape", "Gia Vien District, Ninh Binh", "Ninh Binh", "Known as the 'Ha Long Bay on land,' featuring towering karst peaks and boat tours through caves.", "400x120/facc15/ffffff?text=River+Caves"], 
            [10.0500, 103.9500, "Sao Beach", "Phu Quoc Island, Kien Giang", "Kien Giang", "One of the most beautiful beaches in Phu Quoc, known for its white sand and gentle waves.", "400x120/1e40af/ffffff?text=Pristine+Beach"], 
            [11.9400, 108.4400, "Xuan Huong Lake", "Da Lat City Center, Lam Dong", "Lam Dong", "A peaceful lake in the heart of the romantic mountain city of Da Lat.", "400x120/99f6e4/ffffff?text=Dalat+Lake"],
            
            [21.0320, 105.8430, "Tong Duy Tan Street", "Hoan Kiem District, Hanoi", "Hanoi", "A small street famous for its late-night street food stalls and variety of local dishes.", "400x120/f43f5e/ffffff?text=Street+Food+Stalls"],
            [21.0500, 105.8650, "Long Bien Bridge", "Connecting Long Bien and Ba Dinh Districts, Hanoi", "Hanoi", "A historical cantilever bridge built by the French, symbolizing Hanoi's resilient past.", "400x120/4ade80/ffffff?text=Historical+Bridge"],
            [21.0360, 105.8360, "One Pillar Pagoda", "Dien Bien Ward, Ba Dinh District, Hanoi", "Hanoi", "A historic Buddhist temple with a unique single-pillar structure, resembling a lotus flower.", "400x120/f9a8d4/ffffff?text=Lotus+Pagoda"],
            [10.7780, 106.6980, "Tan Dinh Church (Pink Church)", "289 Hai Ba Trung, Dist. 1, HCMC", "HCMC", "A distinctive Roman Catholic church known for its striking pink exterior.", "400x120/f97316/ffffff?text=Pink+Church"],
            [15.9800, 108.2500, "Marble Mountains", "Ngu Hanh Son District, Da Nang", "Da Nang", "A cluster of five marble and limestone hills containing caves, tunnels, and pagodas.", "Da Nang", "400x120/5eead4/ffffff?text=Caves+%26+Pagodas"],
            [22.3700, 103.8000, "Silver Waterfall", "Sapa, Lao Cai", "Lao Cai", "A beautiful waterfall located near Sapa, known for its powerful flow and cool mist.", "400x120/38bdf8/ffffff?text=Sapa+Waterfall"],
            [20.2100, 105.9000, "Tam Coc - Bich Dong", "Ninh Hai Commune, Ninh Binh", "Ninh Binh", "Famous for its limestone karsts and rice paddies, often explored by rowing boat.", "400x120/c084fc/ffffff?text=Rice+Paddies"],
            [16.4637, 107.5909, "Thien Mu Pagoda", "Hue", "Hue", "The tallest pagoda in Vietnam, overlooking the Perfume River, a symbol of Hue.", "400x120/8b5cf6/ffffff?text=Tallest+Pagoda"],
            [16.4688, 107.5762, "Imperial Citadel of Hue", "Hue", "Hue", "A walled fortress and palace, once the seat of the Nguyen Dynasty emperors.", "400x120/f472b6/ffffff?text=Imperial+Palace"],
            [10.0200, 105.7800, "Cai Rang Floating Market", "Can Tho", "Can Tho", "The largest floating market in the Mekong Delta, bustling with boats selling goods.", "400x120/4c1d95/ffffff?text=Floating+Market"],
            [20.7800, 107.0500, "Cat Ba Island", "Hai Phong", "Hai Phong", "The largest island in the Cat Ba Archipelago, known for its national park and beautiful beaches.", "400x120/0f766e/ffffff?text=Island+National+Park"],
            [10.5500, 107.4500, "Ho Tram Beach", "Ba Ria - Vung Tau", "Ba Ria - Vung Tau", "A tranquil coastal area known for its pristine beaches and resort complexes.", "400x120/525252/ffffff?text=Tranquil+Beach"],
            [21.0380, 105.8300, "Ba Dinh Square", "Hanoi", "Hanoi", "The largest square in Vietnam, where President Ho Chi Minh read the Declaration of Independence.", "400x120/4338ca/ffffff?text=Historical+Square"]
        ];

        // Convert raw data to objects
        const locations = rawLocations.map(([lat, lng, name, address, city, description, imageStub], index) => ({
            id: index,
            lat, lng, name, address, city, description, 
            imageUrl: `https://placehold.co/${imageStub}`
        }));

        // Khai báo biến toàn cục cho Leaflet
        let map;
        let allMarkers = []; // Array containing all Leaflet Marker objects
        let markerLayerGroup; // Layer group for easy marker management
        let locationCounts = {}; // Stores the count of locations per city for size scaling

        // --- Leaflet Map Initialization ---
        
        function initializeLeafletMap() {
            const VIETNAM_CENTER = [16.0, 107.5]; 
            const INITIAL_ZOOM = 5.5; 

            // 1. Initialize map
            map = L.map('leaflet-map').setView(VIETNAM_CENTER, INITIAL_ZOOM);

            // 2. Add Tile Layer (Base map)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);

            // Initialize LayerGroup to manage markers
            markerLayerGroup = L.layerGroup().addTo(map);
            
            // Calculate location density per city for scaling
            calculateLocationCounts();

            // 3. Create and store all markers
            createAllMarkers();
            
            // Initial render
            renderFilteredMarkers(locations); 

            // Populate filter and recommendations
            populateCityFilter();
            renderTopRecommendations(locations.slice(0, 8)); // Show 8 initial recommendations
        }
        
        // Calculate location density per city
        function calculateLocationCounts() {
             locationCounts = locations.reduce((acc, loc) => {
                acc[loc.city] = (acc[loc.city] || 0) + 1;
                return acc;
            }, {});
        }

        // Function to determine the radius based on city density
        function getCircleRadius(city) {
            const count = locationCounts[city] || 1;
            // Base radius 8, scaled up by 2 for each additional point in the city (for visual clustering effect)
            return 8 + (count * 2); 
        }

        // Create all Circle Markers once
        function createAllMarkers() {
            allMarkers = locations.map(loc => {
                // Use L.circleMarker instead of L.marker
                const marker = L.circleMarker([loc.lat, loc.lng], {
                    radius: getCircleRadius(loc.city), // Dynamic radius based on density
                    fillColor: "#ef4444", // Red fill
                    color: "#fff", // White stroke
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // Popup Content
                const popupContent = `
                    <div class="p-1 font-inter">
                        <p class="font-bold text-base text-indigo-700">${loc.name}</p>
                        <p class="text-xs text-gray-600">${loc.address}</p>
                        <p class="text-xs mt-1 text-gray-500 italic">City: ${loc.city}</p>
                    </div>
                `;

                marker.bindPopup(popupContent, { maxWidth: 300 });
                marker.locationData = loc; // Attach data to the marker object
                return marker;
            });
        }

        // Populate City Filter Dropdown
        function populateCityFilter() {
            const filterSelect = document.getElementById('city-filter');
            const uniqueCities = [...new Set(locations.map(loc => loc.city))].sort();
            
            uniqueCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                filterSelect.appendChild(option);
            });
        }
        
        // --- Marker and Search Handling ---

        /**
         * Filters locations based on search text and city selection, then renders the map and list.
         */
        function filterAndRender() {
            const nameSearchTerm = document.getElementById('name-search-input').value.toLowerCase().trim();
            const selectedCity = document.getElementById('city-filter').value;
            
            let filteredLocations = locations.filter(loc => {
                // Filter by name/address
                const matchesName = !nameSearchTerm || 
                                    loc.name.toLowerCase().includes(nameSearchTerm) ||
                                    loc.address.toLowerCase().includes(nameSearchTerm);
                
                // Filter by city
                const matchesCity = !selectedCity || loc.city === selectedCity;
                
                return matchesName && matchesCity;
            });
            
            // Update search results count
            document.getElementById('search-results-count').textContent = `(${filteredLocations.length} results)`;

            // Render map markers and recommendations list
            renderFilteredMarkers(filteredLocations);
            renderTopRecommendations(filteredLocations.slice(0, 8)); // Show up to 8 results in the list
        }

        /**
         * Displays markers corresponding to the filtered locations list.
         * @param {Array<Object>} locationsToShow - List of locations to display.
         */
        function renderFilteredMarkers(locationsToShow) {
            // Clear all current markers from the LayerGroup
            markerLayerGroup.clearLayers();

            // Find and re-add the corresponding markers
            locationsToShow.forEach(loc => {
                const marker = allMarkers.find(m => m.locationData.id === loc.id);
                if (marker) {
                    marker.addTo(markerLayerGroup);
                }
            });
            
            // Optionally, fit the map bounds to the filtered markers if there are results
            if (locationsToShow.length > 0) {
                const bounds = locationsToShow.map(loc => [loc.lat, loc.lng]);
                map.fitBounds(bounds, {padding: [50, 50], maxZoom: 8});
            } else {
                // If no results, reset to Vietnam center
                map.setView([16.0, 107.5], 5.5);
            }
        }
        
        // --- Top Recommendations Rendering ---

        /**
         * Renders the detailed list of recommended (or filtered) locations.
         * @param {Array<Object>} recommendedLocs - List of locations.
         */
        function renderTopRecommendations(recommendedLocs) {
            const listContainer = document.getElementById('recommendations-list');
            listContainer.innerHTML = '';
            
            recommendedLocs.forEach(loc => {
                const card = document.createElement('div');
                card.classList.add('recommendation-card', 'bg-white', 'rounded-xl', 'border-2', 'border-gray-100', 'shadow-lg');
                card.setAttribute('data-lat', loc.lat);
                card.setAttribute('data-lng', loc.lng);
                
                // Note: The imageUrl now contains a descriptive text placeholder
                card.innerHTML = `
                    <img src="${loc.imageUrl}" alt="${loc.name}" class="card-image">
                    <div class="p-4 flex-grow">
                        <p class="font-extrabold text-lg text-indigo-700 mb-1">${loc.name}</p>
                        <p class="text-sm text-gray-500 mb-2 truncate">${loc.address}</p>
                        <p class="text-xs text-gray-600 line-clamp-3">${loc.description}</p>
                    </div>
                `;

                // Handle click event to fly to the location on the map
                card.addEventListener('click', (e) => {
                    const lat = parseFloat(e.currentTarget.getAttribute('data-lat'));
                    const lng = parseFloat(e.currentTarget.getAttribute('data-lng'));
                    
                    // Fly to the coordinate and zoom in
                    map.flyTo([lat, lng], 13); 
                    
                    // Open the corresponding marker's popup
                    const marker = allMarkers.find(m => m.locationData.lat === lat && m.locationData.lng === lng);
                    if (marker) {
                        marker.openPopup();
                    }
                });

                listContainer.appendChild(card);
            });
        }
        
        // --- Initialization and Event Listeners ---
        
        function initializeApp() {
            initializeLeafletMap();
            
            // Attach event listeners for search and filter
            const nameInput = document.getElementById('name-search-input');
            const cityFilter = document.getElementById('city-filter');
            
            let searchTimeout;
            
            const handleFilterChange = (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterAndRender();
                }, 300); // 300ms debounce
            };

            nameInput.addEventListener('input', handleFilterChange);
            cityFilter.addEventListener('change', handleFilterChange);
            
            // Set initial count
            document.getElementById('search-results-count').textContent = `(${locations.length} results)`;
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
